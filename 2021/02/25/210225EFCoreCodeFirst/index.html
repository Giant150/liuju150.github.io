<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="奕晨博苑 Giant Blog">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          EF Core的Code First模式 - Giant Blog
        
    </title>

    <link rel="canonical" href="https://www.giantliu.cn/2021/02/25/210225EFCoreCodeFirst/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/hux-blog.min.css">


    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?d82d45effacb37116464fe90db51d3da";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
      </script>
<meta name="generator" content="Hexo 5.0.0"><link rel="alternate" href="/atom.xml" title="Giant Blog" type="application/atom+xml">
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Giant Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="https://www.giantliu.cn/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/dotnet.jpg')
        
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#随笔" title="随笔">随笔</a>
                        
                          <a class="tag" href="/tags/#NetCore" title="NetCore">NetCore</a>
                        
                    </div>
                    <h1>EF Core的Code First模式</h1>
                    <h2 class="subheading">使用Entity Framework Core的Code First生成实体，并迁移到数据库</h2>
                    <span class="meta">
                        Posted by 刘巨 on
                        2021-02-25
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-12
                col-md-12
                post-container">

                <h2 id="Entity-Framework-Core"><a href="#Entity-Framework-Core" class="headerlink" title="Entity Framework Core"></a>Entity Framework Core</h2><p>Entity Framework (EF) Core 是轻量化、可扩展、开源和跨平台版的常用 Entity Framework 数据访问技术。<br>EF Core 可用作对象关系映射程序 (O/RM)，这可以实现以下两点：<br>使 .NET 开发人员能够使用 .NET 对象处理数据库。<br>无需再像通常那样编写大部分数据访问代码。</p>
<p>EF 支持以下模型开发方法：</p>
<ul>
<li>Database First:先有数据库，后有实体模型。从现有数据库生成模型。对模型手动编码，使其符合数据库。</li>
<li>Code First：创建模型后，使用 EF 迁移从模型创建数据库。 模型发生变化时，迁移可让数据库不断演进。先有实体模型，后生成数据库</li>
</ul>
<h2 id="创建模型"><a href="#创建模型" class="headerlink" title="创建模型"></a>创建模型</h2><h3 id="通用模型"><a href="#通用模型" class="headerlink" title="通用模型"></a>通用模型</h3><p>数据表，都会有主键字段。为了满足此需求，所以我们建立一个通用的泛型模型BaseEntity</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通用基本模型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;K&quot;&gt;</span>主键类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseEntity</span>&lt;<span class="title">K</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Id,主键</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> K Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通用模型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseEntity</span> : <span class="title">BaseEntity</span>&lt;<span class="title">string</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了让系统知道我们的Id字段是主键，我们增加了对通用模型的配置<br>EF可以有两种方法来配置实体，一种是使用数据批注(Attribute)<br>还有一种是Fluent API，就是通过代码来对模型配置<br>本示例使用Fluent API来配置<br>因为有些特殊情况是不能使用数据批注(Attribute)来满足要求<br>比如多主键，多外键，关联等情况。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 默认实体配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> OnModelCreating</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;K&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseEntityTypeConfig</span>&lt;<span class="title">T</span>, <span class="title">K</span>&gt; : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">    <span class="keyword">where</span> <span class="title">T</span> : <span class="title">BaseEntity</span>&lt;<span class="title">K</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;T&gt; builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 主外键关系</span></span><br><span class="line">        builder.HasKey(k =&gt; k.Id);<span class="comment">//设置主键</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 字段属性:最大长度,是否必需,默认值</span></span><br><span class="line">        </span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 备注</span></span><br><span class="line">        builder.Property(p =&gt; p.Id).HasComment(<span class="string">&quot;主键&quot;</span>);<span class="comment">//设置备注</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseEntityTypeConfig</span>&lt;<span class="title">T</span>&gt; : <span class="title">BaseEntityTypeConfig</span>&lt;<span class="title">T</span>, <span class="title">string</span>&gt;, <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">    <span class="keyword">where</span> <span class="title">T</span> : <span class="title">BaseEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;T&gt; builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Configure(builder);</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 主外键关系</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 字段属性:最大长度,是否必需,默认值</span></span><br><span class="line">        builder.Property(p =&gt; p.Id).HasMaxLength(<span class="number">50</span>);<span class="comment">//设置主键最大长度50</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 备注</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于业务实体，一般我们又会有些其它通过字段，比如创建人，创建时间，修改人，修改时间，是否删除等公共字段<br>所以我们创建了BusEntity通用业务模型</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 业务实体基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;K&quot;&gt;</span>主键类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BusEntity</span>&lt;<span class="title">K</span>&gt; : <span class="title">BaseEntity</span>&lt;<span class="title">K</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否删除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> Deleted &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建人</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> K CreateUserId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> DateTime CreateTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 修改人</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> K ModifyUserId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 修改时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> DateTime ModifyTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 业务实体基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BusEntity</span> : <span class="title">BusEntity</span>&lt;<span class="title">string</span>&gt;</span><br><span class="line">&#123; &#125;</span><br></pre></td></tr></table></figure>

<p>对于基本业务实体基类用以下配置</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 默认实体配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> OnModelCreating</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;K&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BusEntityTypeConfig</span>&lt;<span class="title">T</span>, <span class="title">K</span>&gt; : <span class="title">BaseEntityTypeConfig</span>&lt;<span class="title">T</span>, <span class="title">K</span>&gt;, <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">    <span class="keyword">where</span> <span class="title">T</span> : <span class="title">BusEntity</span>&lt;<span class="title">K</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;T&gt; builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Configure(builder);</span><br><span class="line">        builder.HasQueryFilter(q =&gt; q.Deleted == <span class="literal">false</span>);<span class="comment">//查询自动过滤已经删除的记录</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 主外键关系</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 字段属性:最大长度,是否必需,默认值</span></span><br><span class="line">        builder.Property(p =&gt; p.Deleted).HasDefaultValue(<span class="literal">false</span>);<span class="comment">//把是否删除设置为默认False</span></span><br><span class="line">        builder.Property(p =&gt; p.CreateUserId).HasMaxLength(<span class="number">50</span>);<span class="comment">//把创建人设置为默认值</span></span><br><span class="line">        builder.Property(p =&gt; p.ModifyUserId).HasMaxLength(<span class="number">50</span>);<span class="comment">//把修改人设置为默认值</span></span><br><span class="line">        builder.Property(p =&gt; p.CreateTime).HasDefaultValueSql(<span class="string">&quot;getdate()&quot;</span>).ValueGeneratedOnAdd();<span class="comment">//把创建时间设置默认值并在增加的时候更新值</span></span><br><span class="line">        builder.Property(p =&gt; p.ModifyTime).HasDefaultValueSql(<span class="string">&quot;getdate()&quot;</span>).ValueGeneratedOnAddOrUpdate();<span class="comment">//把修改时间设置默认值并在增加和修改的时候更新值</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 备注</span></span><br><span class="line">        builder.Property(p =&gt; p.Deleted).HasComment(<span class="string">&quot;是否删除&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.CreateUserId).HasComment(<span class="string">&quot;创建人&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.CreateTime).HasComment(<span class="string">&quot;创建时间&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.ModifyUserId).HasComment(<span class="string">&quot;修改人&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.ModifyTime).HasComment(<span class="string">&quot;修改时间&quot;</span>);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BusEntityTypeConfig</span>&lt;<span class="title">T</span>&gt; : <span class="title">BusEntityTypeConfig</span>&lt;<span class="title">T</span>, <span class="title">string</span>&gt;, <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">    <span class="keyword">where</span> <span class="title">T</span> : <span class="title">BusEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;T&gt; builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Configure(builder);</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 主外键关系</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 字段属性:最大长度,是否必需,默认值</span></span><br><span class="line">        builder.Property(p =&gt; p.Id).HasMaxLength(<span class="number">50</span>);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 备注</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="业务模型"><a href="#业务模型" class="headerlink" title="业务模型"></a>业务模型</h3><p>接下来我们有了通用模型基类。那么我们就可以来创建具体的业务模型<br>比如说我们的组织架构模型<br>我们使用两个局部类来定义，<br>第一个局部类定义基本属性<br>第二个局部类定义关联关系<br>然后对模型进行配置</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组织架构</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Sys_Org</span> : <span class="title">BusEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 上级组织</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ParentId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 名称</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Sys_Org</span> : <span class="title">BusEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 上级组织</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Sys_Org Parent &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 下级组织</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Sys_Org&gt; Childs &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 实体配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> OnModelCreating</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sys_OrgTypeConfig</span> : <span class="title">BusEntityTypeConfig</span>&lt;<span class="title">Sys_Org</span>&gt;, <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">Sys_Org</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;Sys_Org&gt; builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Configure(builder);</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 主外键关系</span></span><br><span class="line">        builder.HasOne(p =&gt; p.Parent).WithMany(p =&gt; p.Childs).HasForeignKey(p =&gt; p.ParentId);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 字段属性:最大长度,是否必需,默认值</span></span><br><span class="line">        builder.Property(p =&gt; p.Name).HasMaxLength(<span class="number">50</span>).IsRequired();</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 备注</span></span><br><span class="line">        builder.Property(p =&gt; p.ParentId).HasComment(<span class="string">&quot;上级组织&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.Name).HasComment(<span class="string">&quot;名称&quot;</span>);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 系统用户</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Sys_User</span> : <span class="title">BusEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 工号、编码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 名称</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用户名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 密码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Status &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所属组织</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> OrgId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 性别</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Sex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Sys_User</span> : <span class="title">BusEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所属组织</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Sys_Org Org &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 实体配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> OnModelCreating</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sys_UserTypeConfig</span> : <span class="title">BusEntityTypeConfig</span>&lt;<span class="title">Sys_User</span>&gt;, <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">Sys_User</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;Sys_User&gt; builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Configure(builder);</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 主外键关系</span></span><br><span class="line">        builder.HasOne(p =&gt; p.Org).WithMany().HasForeignKey(p =&gt; p.OrgId);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 字段属性:最大长度,是否必需,默认值</span></span><br><span class="line">        builder.Property(p =&gt; p.Code).HasMaxLength(<span class="number">50</span>);</span><br><span class="line">        builder.Property(p =&gt; p.Name).HasMaxLength(<span class="number">50</span>).IsRequired();</span><br><span class="line">        builder.Property(p =&gt; p.UserName).HasMaxLength(<span class="number">50</span>).IsRequired();</span><br><span class="line">        builder.Property(p =&gt; p.Password).HasMaxLength(<span class="number">100</span>).IsRequired();</span><br><span class="line">        builder.Property(p =&gt; p.Status).HasMaxLength(<span class="number">50</span>).IsRequired();</span><br><span class="line">        builder.Property(p =&gt; p.OrgId).HasMaxLength(<span class="number">50</span>);</span><br><span class="line">        builder.Property(p =&gt; p.Sex).HasMaxLength(<span class="number">50</span>);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> 备注</span></span><br><span class="line">        builder.Property(p =&gt; p.Code).HasComment(<span class="string">&quot;编码&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.Name).HasComment(<span class="string">&quot;名称&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.UserName).HasComment(<span class="string">&quot;用户名&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.Password).HasComment(<span class="string">&quot;密码&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.Status).HasComment(<span class="string">&quot;状态&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.OrgId).HasComment(<span class="string">&quot;所属组织&quot;</span>);</span><br><span class="line">        builder.Property(p =&gt; p.Sex).HasComment(<span class="string">&quot;性别&quot;</span>);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建数据库上下文Context"><a href="#创建数据库上下文Context" class="headerlink" title="创建数据库上下文Context"></a>创建数据库上下文Context</h3><p>有了数据模型，接下来我们创建数据库上下文Context<br>OnConfiguring用来配置数据连接字符串<br>OnModelCreating是创建模型是对模型的配置<br>因为上面我们对每个模型都做了配置(实现了IEntityTypeConfiguration)<br>所以在这里我们只要把具体的配置配置应用到Context就行了<br>我们使用modelBuilder.ApplyConfigurationsFromAssembly<br>就可以把所有实现了IEntityTypeConfiguration的模型配置全部应用到数据库上下文</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GDbContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Context配置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;optionsBuilder&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnConfiguring</span>(<span class="params">DbContextOptionsBuilder optionsBuilder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnConfiguring(optionsBuilder);</span><br><span class="line">        optionsBuilder.UseSqlServer(<span class="string">&quot;Data Source=x.x.x.x;Initial Catalog=数据库名称;User Id=用户名;Password=密码;APP=系统名称;Pooling=true;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 模型创建</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;modelBuilder&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnModelCreating(modelBuilder);</span><br><span class="line">        modelBuilder.ApplyConfigurationsFromAssembly(<span class="keyword">this</span>.GetType().Assembly);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 组织架构</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> DbSet&lt;Sys_Org&gt; Sys_Org &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用户</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> DbSet&lt;Sys_User&gt; Sys_User &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有代码结构如下<br><img src="1.png" alt="CodeFirst"></p>
<h2 id="迁移数据库"><a href="#迁移数据库" class="headerlink" title="迁移数据库"></a>迁移数据库</h2><p>专业名称叫迁移，通用解释就是把实体模型生成为数据表<br>我们在OnConfiguring中已经配置了使用SqlServer数据库（当然也支持其它所有类型数据库：如MySql,Oracle,Sqlite等其它数据库）<br>使用迁移，必需安装Microsoft.EntityFrameworkCore.Tools工具集<br>接下来我们在“程序包管理控制台”输入Add-Migration FirstInit   (FirstInit:自定义名称)<br>系统会自动帮我们生成迁移代码<br><img src="2.png" alt="CodeFirst"><br><img src="3.png" alt="CodeFirst"></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">FirstInit</span> : <span class="title">Migration</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Up</span>(<span class="params">MigrationBuilder migrationBuilder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        migrationBuilder.CreateTable(</span><br><span class="line">            name: <span class="string">&quot;Sys_Org&quot;</span>,</span><br><span class="line">            columns: table =&gt; <span class="keyword">new</span></span><br><span class="line">            &#123;</span><br><span class="line">                Id = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">false</span>, comment: <span class="string">&quot;主键&quot;</span>),</span><br><span class="line">                ParentId = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, nullable: <span class="literal">true</span>, comment: <span class="string">&quot;上级组织&quot;</span>),</span><br><span class="line">                Name = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">false</span>, comment: <span class="string">&quot;名称&quot;</span>),</span><br><span class="line">                Deleted = table.Column&lt;<span class="keyword">bool</span>&gt;(type: <span class="string">&quot;bit&quot;</span>, nullable: <span class="literal">false</span>, defaultValue: <span class="literal">false</span>, comment: <span class="string">&quot;是否删除&quot;</span>),</span><br><span class="line">                CreateUserId = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">true</span>, comment: <span class="string">&quot;创建人&quot;</span>),</span><br><span class="line">                CreateTime = table.Column&lt;DateTime&gt;(type: <span class="string">&quot;datetime2&quot;</span>, nullable: <span class="literal">false</span>, defaultValueSql: <span class="string">&quot;getdate()&quot;</span>, comment: <span class="string">&quot;创建时间&quot;</span>),</span><br><span class="line">                ModifyUserId = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">true</span>, comment: <span class="string">&quot;修改人&quot;</span>),</span><br><span class="line">                ModifyTime = table.Column&lt;DateTime&gt;(type: <span class="string">&quot;datetime2&quot;</span>, nullable: <span class="literal">false</span>, defaultValueSql: <span class="string">&quot;getdate()&quot;</span>, comment: <span class="string">&quot;修改时间&quot;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            constraints: table =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                table.PrimaryKey(<span class="string">&quot;PK_Sys_Org&quot;</span>, x =&gt; x.Id);</span><br><span class="line">                table.ForeignKey(</span><br><span class="line">                    name: <span class="string">&quot;FK_Sys_Org_Sys_Org_ParentId&quot;</span>,</span><br><span class="line">                    column: x =&gt; x.ParentId,</span><br><span class="line">                    principalTable: <span class="string">&quot;Sys_Org&quot;</span>,</span><br><span class="line">                    principalColumn: <span class="string">&quot;Id&quot;</span>,</span><br><span class="line">                    onDelete: ReferentialAction.Restrict);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        migrationBuilder.CreateTable(</span><br><span class="line">            name: <span class="string">&quot;Sys_User&quot;</span>,</span><br><span class="line">            columns: table =&gt; <span class="keyword">new</span></span><br><span class="line">            &#123;</span><br><span class="line">                Id = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">false</span>, comment: <span class="string">&quot;主键&quot;</span>),</span><br><span class="line">                Code = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">true</span>, comment: <span class="string">&quot;编码&quot;</span>),</span><br><span class="line">                Name = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">false</span>, comment: <span class="string">&quot;名称&quot;</span>),</span><br><span class="line">                UserName = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">false</span>, comment: <span class="string">&quot;用户名&quot;</span>),</span><br><span class="line">                Password = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(100)&quot;</span>, maxLength: <span class="number">100</span>, nullable: <span class="literal">false</span>, comment: <span class="string">&quot;密码&quot;</span>),</span><br><span class="line">                Status = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">false</span>, comment: <span class="string">&quot;状态&quot;</span>),</span><br><span class="line">                OrgId = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">true</span>, comment: <span class="string">&quot;所属组织&quot;</span>),</span><br><span class="line">                Sex = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">true</span>, comment: <span class="string">&quot;性别&quot;</span>),</span><br><span class="line">                Deleted = table.Column&lt;<span class="keyword">bool</span>&gt;(type: <span class="string">&quot;bit&quot;</span>, nullable: <span class="literal">false</span>, defaultValue: <span class="literal">false</span>, comment: <span class="string">&quot;是否删除&quot;</span>),</span><br><span class="line">                CreateUserId = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">true</span>, comment: <span class="string">&quot;创建人&quot;</span>),</span><br><span class="line">                CreateTime = table.Column&lt;DateTime&gt;(type: <span class="string">&quot;datetime2&quot;</span>, nullable: <span class="literal">false</span>, defaultValueSql: <span class="string">&quot;getdate()&quot;</span>, comment: <span class="string">&quot;创建时间&quot;</span>),</span><br><span class="line">                ModifyUserId = table.Column&lt;<span class="keyword">string</span>&gt;(type: <span class="string">&quot;nvarchar(50)&quot;</span>, maxLength: <span class="number">50</span>, nullable: <span class="literal">true</span>, comment: <span class="string">&quot;修改人&quot;</span>),</span><br><span class="line">                ModifyTime = table.Column&lt;DateTime&gt;(type: <span class="string">&quot;datetime2&quot;</span>, nullable: <span class="literal">false</span>, defaultValueSql: <span class="string">&quot;getdate()&quot;</span>, comment: <span class="string">&quot;修改时间&quot;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            constraints: table =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                table.PrimaryKey(<span class="string">&quot;PK_Sys_User&quot;</span>, x =&gt; x.Id);</span><br><span class="line">                table.ForeignKey(</span><br><span class="line">                    name: <span class="string">&quot;FK_Sys_User_Sys_Org_OrgId&quot;</span>,</span><br><span class="line">                    column: x =&gt; x.OrgId,</span><br><span class="line">                    principalTable: <span class="string">&quot;Sys_Org&quot;</span>,</span><br><span class="line">                    principalColumn: <span class="string">&quot;Id&quot;</span>,</span><br><span class="line">                    onDelete: ReferentialAction.Restrict);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        migrationBuilder.CreateIndex(</span><br><span class="line">            name: <span class="string">&quot;IX_Sys_Org_ParentId&quot;</span>,</span><br><span class="line">            table: <span class="string">&quot;Sys_Org&quot;</span>,</span><br><span class="line">            column: <span class="string">&quot;ParentId&quot;</span>);</span><br><span class="line"></span><br><span class="line">        migrationBuilder.CreateIndex(</span><br><span class="line">            name: <span class="string">&quot;IX_Sys_User_OrgId&quot;</span>,</span><br><span class="line">            table: <span class="string">&quot;Sys_User&quot;</span>,</span><br><span class="line">            column: <span class="string">&quot;OrgId&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Down</span>(<span class="params">MigrationBuilder migrationBuilder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        migrationBuilder.DropTable(</span><br><span class="line">            name: <span class="string">&quot;Sys_User&quot;</span>);</span><br><span class="line"></span><br><span class="line">        migrationBuilder.DropTable(</span><br><span class="line">            name: <span class="string">&quot;Sys_Org&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="更新到数据库"><a href="#更新到数据库" class="headerlink" title="更新到数据库"></a>更新到数据库</h3><p>我们通过Update-Database命令更新到数据库<br><img src="5.png" alt="CodeFirst"><br><img src="6.png" alt="CodeFirst"></p>
<h3 id="生成SQL脚本更新到生产数据库"><a href="#生成SQL脚本更新到生产数据库" class="headerlink" title="生成SQL脚本更新到生产数据库"></a>生成SQL脚本更新到生产数据库</h3><p>有时候我们系统已经在运行了。开始也不可能直接连接生产数据库<br>那么我们修改了模型，可以通过生成SQL脚本，来更新数据库</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#起始迁移点(没有写<span class="number">0</span>)</span><br><span class="line">#结束迁移点</span><br><span class="line">Script-Migration -From <span class="number">0</span> -To <span class="number">20210225022927</span>_FirstInit</span><br></pre></td></tr></table></figure>

<p><img src="7.png" alt="CodeFirst"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">IF OBJECT_ID(N&#x27;[__EFMigrationsHistory]&#x27;) IS NULL</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [__EFMigrationsHistory] (</span><br><span class="line">        [MigrationId] <span class="keyword">nvarchar</span>(<span class="number">150</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">        [ProductVersion] <span class="keyword">nvarchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">        <span class="keyword">CONSTRAINT</span> [PK___EFMigrationsHistory] PRIMARY <span class="keyword">KEY</span> ([MigrationId])</span><br><span class="line">    );</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span> <span class="keyword">TRANSACTION</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [Sys_Org] (</span><br><span class="line">    [<span class="keyword">Id</span>] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [ParentId] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="literal">NULL</span>,</span><br><span class="line">    [<span class="keyword">Name</span>] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [Deleted] <span class="built_in">bit</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CAST</span>(<span class="number">0</span> <span class="keyword">AS</span> <span class="built_in">bit</span>),</span><br><span class="line">    [CreateUserId] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="literal">NULL</span>,</span><br><span class="line">    [CreateTime] datetime2 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> (<span class="keyword">getdate</span>()),</span><br><span class="line">    [ModifyUserId] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="literal">NULL</span>,</span><br><span class="line">    [ModifyTime] datetime2 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> (<span class="keyword">getdate</span>()),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> [PK_Sys_Org] PRIMARY <span class="keyword">KEY</span> ([<span class="keyword">Id</span>]),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> [FK_Sys_Org_Sys_Org_ParentId] <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> ([ParentId]) <span class="keyword">REFERENCES</span> [Sys_Org] ([<span class="keyword">Id</span>]) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">DECLARE</span> @defaultSchema <span class="keyword">AS</span> sysname;</span><br><span class="line"><span class="keyword">SET</span> @defaultSchema = SCHEMA_NAME();</span><br><span class="line"><span class="keyword">DECLARE</span> @description <span class="keyword">AS</span> sql_variant;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;主键&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_Org&#x27;, &#x27;COLUMN&#x27;, N&#x27;Id&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;上级组织&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_Org&#x27;, &#x27;COLUMN&#x27;, N&#x27;ParentId&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;名称&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_Org&#x27;, &#x27;COLUMN&#x27;, N&#x27;Name&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;是否删除&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_Org&#x27;, &#x27;COLUMN&#x27;, N&#x27;Deleted&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;创建人&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_Org&#x27;, &#x27;COLUMN&#x27;, N&#x27;CreateUserId&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;创建时间&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_Org&#x27;, &#x27;COLUMN&#x27;, N&#x27;CreateTime&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;修改人&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_Org&#x27;, &#x27;COLUMN&#x27;, N&#x27;ModifyUserId&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;修改时间&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_Org&#x27;, &#x27;COLUMN&#x27;, N&#x27;ModifyTime&#x27;;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [Sys_User] (</span><br><span class="line">    [<span class="keyword">Id</span>] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [Code] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="literal">NULL</span>,</span><br><span class="line">    [<span class="keyword">Name</span>] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [UserName] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [<span class="keyword">Password</span>] <span class="keyword">nvarchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [<span class="keyword">Status</span>] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [OrgId] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="literal">NULL</span>,</span><br><span class="line">    [Sex] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="literal">NULL</span>,</span><br><span class="line">    [Deleted] <span class="built_in">bit</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CAST</span>(<span class="number">0</span> <span class="keyword">AS</span> <span class="built_in">bit</span>),</span><br><span class="line">    [CreateUserId] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="literal">NULL</span>,</span><br><span class="line">    [CreateTime] datetime2 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> (<span class="keyword">getdate</span>()),</span><br><span class="line">    [ModifyUserId] <span class="keyword">nvarchar</span>(<span class="number">50</span>) <span class="literal">NULL</span>,</span><br><span class="line">    [ModifyTime] datetime2 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> (<span class="keyword">getdate</span>()),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> [PK_Sys_User] PRIMARY <span class="keyword">KEY</span> ([<span class="keyword">Id</span>]),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> [FK_Sys_User_Sys_Org_OrgId] <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> ([OrgId]) <span class="keyword">REFERENCES</span> [Sys_Org] ([<span class="keyword">Id</span>]) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">DECLARE</span> @defaultSchema <span class="keyword">AS</span> sysname;</span><br><span class="line"><span class="keyword">SET</span> @defaultSchema = SCHEMA_NAME();</span><br><span class="line"><span class="keyword">DECLARE</span> @description <span class="keyword">AS</span> sql_variant;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;主键&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;Id&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;编码&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;Code&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;名称&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;Name&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;用户名&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;UserName&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;密码&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;Password&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;状态&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;Status&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;所属组织&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;OrgId&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;性别&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;Sex&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;是否删除&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;Deleted&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;创建人&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;CreateUserId&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;创建时间&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;CreateTime&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;修改人&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;ModifyUserId&#x27;;</span><br><span class="line"><span class="keyword">SET</span> @description = N<span class="string">&#x27;修改时间&#x27;</span>;</span><br><span class="line">EXEC sp_addextendedproperty &#x27;MS_Description&#x27;, @description, &#x27;SCHEMA&#x27;, @defaultSchema, &#x27;TABLE&#x27;, N&#x27;Sys_User&#x27;, &#x27;COLUMN&#x27;, N&#x27;ModifyTime&#x27;;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> [IX_Sys_Org_ParentId] <span class="keyword">ON</span> [Sys_Org] ([ParentId]);</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> [IX_Sys_User_OrgId] <span class="keyword">ON</span> [Sys_User] ([OrgId]);</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [__EFMigrationsHistory] ([MigrationId], [ProductVersion])</span><br><span class="line"><span class="keyword">VALUES</span> (N<span class="string">&#x27;20210225022927_FirstInit&#x27;</span>, N<span class="string">&#x27;5.0.3&#x27;</span>);</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样的话。就只要把这个脚本放到生产环境去运行，<br>那么得到的结果也是和Update-Database结果是一样的</p>

                <hr>
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2021/06/18/20210618WMSAddExpandAttr/" data-toggle="tooltip" data-placement="top" title="为模型添加通用扩展属性">&larr; 上一篇</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2021/01/29/210129ShowServerInfoInTop/" data-toggle="tooltip" data-placement="top" title="桌面置顶显示服务器信息">下一篇 &rarr;</a>
                        </li>
                    
                </ul>
            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-12
                col-md-12
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#随笔" title="随笔">随笔</a>
                        
                          <a class="tag" href="/tags/#NetCore" title="NetCore">NetCore</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://www.cnblogs.com/liuju150/" target="_blank">博客园</a></li>
                    
                        <li><a href="https://www.zhihu.com/people/giant150" target="_blank">知呼</a></li>
                    
                        <li><a href="https://weibo.com/liuju150" target="_blank">微博</a></li>
                    
                        <li><a href="https://github.com/liuju150" target="_blank">GitHub</a></li>
                    
                        <li><a href="https://gitee.com/GiantLiu" target="_blank">Gitee</a></li>
                    
                        <li><a href="https://giantliu.gitee.io" target="_blank">Gitee Blog</a></li>
                    
                        <li><a href="https://blog.giantliu.cn" target="_blank">Blog</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/giant150">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/liuju150">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/liuju150">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Giant Blog 2021 <br />
                    <a target="_blank" href="http://www.beian.miit.gov.cn/">湘ICP备20015826号-1</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://www.giantliu.cn/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!-- Side Catalog -->



</body>

</html>
